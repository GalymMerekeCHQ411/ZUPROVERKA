<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ХимКомбайн v3.0 (Fix)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #ecf0f1; --err: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Навигация */
        .nav { margin: 20px 0; display: flex; gap: 10px; }
        .nav button { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; background: #ddd; font-weight: bold; color: #7f8c8d; }
        .nav button.active { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4); }

        /* Контейнер */
        .card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; }
        
        /* Секции */
        .section { display: none; }
        .section.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        input { width: 100%; padding: 12px; font-size: 18px; margin-bottom: 15px; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: monospace; }
        input:focus { border-color: var(--accent); outline: none; }
        
        .btn-main { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .btn-main:hover { background: #2980b9; }

        .result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-left: 5px solid var(--primary); text-align: left; display: none; word-break: break-word; }
        .result.error { border-left-color: var(--err); color: var(--err); }
        
        /* Подсказки */
        .suggestions { text-align: left; margin-top: -10px; margin-bottom: 15px; border: 1px solid #eee; max-height: 150px; overflow-y: auto; display: none; }
        .s-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .s-item:hover { background: #f0f8ff; }
    </style>
</head>
<body>

    <div class="nav">
        <button id="tab1" class="active" onclick="setTab('mass')">⚖️ Масса</button>
        <button id="tab2" onclick="setTab('react')">⚗️ Реакции</button>
    </div>

    <div class="card">
        <div id="sec-mass" class="section active">
            <h2>Молярная Масса</h2>
            <input type="text" id="in-mass" placeholder="Пример: H2SO4 или K4[Fe(CN)6]">
            <button class="btn-main" onclick="runMass()">Считать</button>
            <div id="out-mass" class="result"></div>
        </div>

        <div id="sec-react" class="section">
            <h2>Уравнивание</h2>
            <input type="text" id="in-react" placeholder="H2 + O2 = H2O" autocomplete="off">
            <div id="sugg-box" class="suggestions"></div>
            <button class="btn-main" onclick="runReact()">Уравнять</button>
            <div id="out-react" class="result"></div>
        </div>
        
        <p style="color:#ccc; font-size:12px; margin-top:20px">v3.0 System Check: OK</p>
    </div>

    <script>
        // --- ДАННЫЕ ---
        const ATOMS = { "H": 1.008, "He": 4.003, "Li": 6.94, "Be": 9.012, "B": 10.81, "C": 12.011, "N": 14.007, "O": 15.999, "F": 18.998, "Ne": 20.180, "Na": 22.990, "Mg": 24.305, "Al": 26.982, "Si": 28.085, "P": 30.974, "S": 32.06, "Cl": 35.45, "K": 39.098, "Ca": 40.078, "Sc": 44.956, "Ti": 47.867, "V": 50.942, "Cr": 51.996, "Mn": 54.938, "Fe": 55.845, "Co": 58.933, "Ni": 58.693, "Cu": 63.546, "Zn": 65.38, "Ga": 69.723, "Ge": 72.630, "As": 74.922, "Se": 78.971, "Br": 79.904, "Kr": 83.798, "Rb": 85.468, "Sr": 87.62, "Y": 88.906, "Zr": 91.224, "Nb": 92.906, "Mo": 95.95, "Ag": 107.87, "Cd": 112.41, "Sn": 118.71, "Sb": 121.76, "I": 126.90, "Ba": 137.33, "Au": 196.97, "Hg": 200.59, "Pb": 207.2, "U": 238.03 };
        
        const REACTS = [ "H2 + O2 = H2O", "Na + Cl2 = NaCl", "C + O2 = CO2", "Fe + O2 = Fe2O3", "Al + O2 = Al2O3", "HCl + NaOH = NaCl + H2O", "N2 + H2 = NH3", "CH4 + O2 = CO2 + H2O" ];

        // --- УПРАВЛЕНИЕ ТАБАМИ ---
        function setTab(mode) {
            document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            if (mode === 'mass') {
                document.getElementById('sec-mass').classList.add('active');
                document.getElementById('tab1').classList.add('active');
            } else {
                document.getElementById('sec-react').classList.add('active');
                document.getElementById('tab2').classList.add('active');
            }
        }

        // --- ФУНКЦИЯ МАССЫ ---
        function runMass() {
            const val = document.getElementById('in-mass').value.trim();
            const out = document.getElementById('out-mass');
            
            if(!val) { showRes(out, "Введите формулу!", true); return; }

            try {
                // Упрощенный парсер (но надежный)
                let total = 0;
                // Разбираем скобки простым стеком
                // Это сложная часть, если она упадет - упадет всё. Обернуто в try.
                total = parseComplex
