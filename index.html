<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ХимКомбайн PRO (Финальный)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --bg: #ecf0f1; --err: #e74c3c; --ok: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .card { background: white; width: 90%; max-width: 550px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Навигация */
        .nav { display: flex; gap: 10px; margin-bottom: 25px; }
        .nav button { flex: 1; padding: 12px; border: none; background: #f1f2f6; color: #7f8c8d; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; text-align: center; }
        .nav button:hover { background: #e1e2e6; }
        .nav button.active { background: var(--accent); color: white; box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3); }

        /* Поля */
        h2 { margin-top: 0; color: var(--primary); font-size: 1.5em; }
        .group { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 14px; border: 2px solid #dfe4ea; border-radius: 8px; font-size: 18px; box-sizing: border-box; font-family: monospace; transition: 0.3s; }
        input:focus { border-color: var(--accent); outline: none; }

        /* Кнопка действия */
        .action-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { background: #2573a7; }
        .action-btn:active { transform: scale(0.98); }

        /* Результат */
        .result { margin-top: 20px; padding: 15px; border-radius: 8px; background: #f8f9fa; border-left: 5px solid var(--primary); display: none; animation: slideDown 0.3s; }
        .result.error { border-left-color: var(--err); color: var(--err); font-weight: bold; }
        .result.success { border-left-color: var(--ok); }
        .res-big { font-size: 1.8em; font-weight: bold; color: var(--primary); display: block; margin-top: 5px; word-break: break-word; }
        .res-sub { color: #7f8c8d; font-size: 0.9em; }

        /* Подсказки */
        .sugg-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dfe4ea; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 10; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .sugg-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f1f2f6; font-size: 0.95em; color: #2f3542; }
        .sugg-item:hover { background: #f1f2f6; color: var(--accent); }
        
        /* Секции */
        .section { display: none; }
        .section.active { display: block; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <div class="nav">
        <button class="active" onclick="setTab('mass')">⚖️ Масса</button>
        <button onclick="setTab('react')">⚗️ Реакции</button>
    </div>

    <div id="sec-mass" class="section active">
        <h2>Калькулятор Массы</h2>
        <div class="group">
            <input type="text" id="in-mass" placeholder="Например: Ca(OH)2 или K4[Fe(CN)6]" autocomplete="off">
        </div>
        <button class="action-btn" onclick="calcMass()">Рассчитать</button>
        <div id="res-mass" class="result"></div>
    </div>

    <div id="sec-react" class="section">
        <h2>Уравнивание Реакций</h2>
        <div class="group">
            <input type="text" id="in-react" placeholder="Например: Al + O2 = Al2O3" autocomplete="off">
            <div id="sugg-list" class="sugg-box"></div>
        </div>
        <button class="action-btn" style="background:var(--ok)" onclick="calcReact()">Уравнять</button>
        <div id="res-react" class="result"></div>
    </div>
    
    <div style="text-align:center; margin-top:20px; color:#bdc3c7; font-size:12px">PRO Version v4.1 (Final)</div>
</div>

<script>
    /* ================= БАЗА ДАННЫХ ================= */
    const ATOMS = {
        "H": 1.008, "He": 4.003, "Li": 6.94, "Be": 9.012, "B": 10.81, "C": 12.011, "N": 14.007, "O": 15.999, "F": 18.998, "Ne": 20.180, "Na": 22.990, "Mg": 24.305, "Al": 26.982, "Si": 28.085, "P": 30.974, "S": 32.06, "Cl": 35.45, "K": 39.098, "Ca": 40.078, "Sc": 44.956, "Ti": 47.867, "V": 50.942, "Cr": 51.996, "Mn": 54.938, "Fe": 55.845, "Co": 58.933, "Ni": 58.693, "Cu": 63.546, "Zn": 65.38, "Ga": 69.723, "Ge": 72.630, "As": 74.922, "Se": 78.971, "Br": 79.904, "Kr": 83.798, "Rb": 85.468, "Sr": 87.62, "Y": 88.906, "Zr": 91.224, "Nb": 92.906, "Mo": 95.95, "Ag": 107.87, "Cd": 112.41, "Sn": 118.71, "Sb": 121.76, "I": 126.90, "Ba": 137.33, "Au": 196.97, "Hg": 200.59, "Pb": 207.2, "U": 238.03
    };

    const SUGGESTIONS = [
        "H2 + O2 = H2O", "Na + Cl2 = NaCl", "Al + O2 = Al2O3", "Fe + O2 = Fe2O3", "CH4 + O2 = CO2 + H2O",
        "N2 + H2 = NH3", "HCl + NaOH = NaCl + H2O", "KClO3 = KCl + O2", "C6H12O6 + O2 = CO2 + H2O", "Zn + HCl = ZnCl2 + H2"
    ];

    /* ================= ИНТЕРФЕЙС ================= */
    function setTab(tab) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(e => e.classList.remove('active'));
        
        if(tab === 'mass') {
            document.getElementById('sec-mass').classList.add('active');
            document.querySelectorAll('.nav button')[0].classList.add('active');
        } else {
            document.getElementById('sec-react').classList.add('active');
            document.querySelectorAll('.nav button')[1].classList.add('active');
        }
    }

    function showResult(id, html, isError) {
        const el = document.getElementById(id);
        el.style.display = 'block';
        el.classList.remove('error', 'success');
        el.classList.add(isError ? 'error' : 'success');
        el.innerHTML = html;
    }

    /* ================= ЛОГИКА МАССЫ (С ТЕКОМ) ================= */
    function calcMass() {
        const input = document.getElementById('in-mass').value.trim();
        if(!input) return showResult('res-mass', 'Введите формулу!', true);

        try {
            const mass = parseMassFormula(input);
            showResult('res-mass', `<div class="res-sub">Молярная масса <b>${input}</b></div><span class="res-big">${mass.toFixed(3)} <small>г/моль</small></span>`, false);
        } catch(e) {
            showResult('res-mass', `❌ Ошибка парсинга: ${e.message}`, true);
        }
    }

    function parseMassFormula(formula) {
        const regex = /([A-Z][a-z]*)|(\d+)|([()\[\]])/g;
        const tokens = formula.match(regex);
        if(!tokens) throw new Error("Некорректная формула");

        let stack = [[]];
        
        for(let t of tokens) {
            let top = stack[stack.length - 1];
            
            if(!isNaN(t)) { // Число
                if(top.length === 0) throw new Error("Число в начале элемента");
                top[top.length-1].m *= parseInt(t);
            } else if("([{".includes(t)) { // Открывающая
                stack.push([]);
            } else if(")]}".includes(t)) { // Закрывающая
                if(stack.length === 1) throw new Error("Лишняя скобка");
                let group = stack.pop();
                let grMass = group.reduce((sum, i) => sum + i.m, 0);
                stack[stack.length-1].push({m: grMass});
            } else { // Элемент
                if(!ATOMS[t]) throw new Error(`Элемент "${t}" не найден`);
                top.push({m: ATOMS[t]});
            }
        }
        if(stack.length > 1) throw new Error("Не закрыта скобка");
        return stack[0].reduce((sum, i) => sum + i.m, 0);
    }

    /* ================= ЛОГИКА РЕАКЦИЙ (АЛГОРИТМ) ================= */
    function calcReact() {
        let eq = document.getElementById('in-react').value.replace('->', '=');
        if(!eq.includes('=')) return showResult('res-react', "Нет знака '='", true);

        try {
            const parts = eq.split('=').map(s => s.trim());
            const leftAtoms = getAtomsSet(parts[0]);
            const rightAtoms = getAtomsSet(parts[1]);
            
            // 1. Проверка на исчезновение/появление атомов
            const diff = [...leftAtoms].filter(x => !rightAtoms.has(x));
            const diff2 = [...rightAtoms].filter(x => !leftAtoms.has(x));

            if(diff.length > 0 || diff2.length > 0) {
                 throw new Error(`Невозможная реакция! Нарушен закон сохранения массы. Несоответствие: ${[...diff, ...diff2].join(', ')}`);
            }

            // 2. Уравнивание (Гибридный метод)
            let balanced = solveChemistry(eq);
            showResult('res-react', `<div class="res-sub">Уравнение:</div><span class="res-big" style="font-size:1.4em">${balanced}</span>`, false);

        } catch(e) {
            showResult('res-react', `❌ Ошибка: ${e.message}`, true);
        }
    }

    function getAtomsSet(str) {
        const set = new Set();
        const regex = /([A-Z][a-z]*)/g;
        let m;
        while((m = regex.exec(str)) !== null) set.add(m[1]);
        return set;
    }

    function solveChemistry(eq) {
        let clean = eq.replace(/\s/g, '');
        
        // Быстрый поиск по базе
        const DB = {
            "H2+O2=H2O": "2H2 + O2 = 2H2O", "Na+Cl2=NaCl": "2Na + Cl2 = 2NaCl", "Al+O2=Al2O3": "4Al + 3O2 = 2Al2O3",
            "Fe+O2=Fe2O3": "4Fe + 3O2 = 2Fe2O3", "N2+H2=NH3": "N2 + 3H2 = 2NH3", "CH4+O2=CO2+H2O": "CH4 + 2O2 = CO2 + 2H2O",
            "Zn+HCl=ZnCl2+H2": "Zn + 2HCl = ZnCl2 + H2", "H2O=H2+O2": "2H2O = 2H2 + O2", "KClO3=KCl+O2": "2KClO3 = 2KCl + 3O2"
        };
        
        if(DB[clean]) return DB[clean];

        // Фалбэк для остальных проверенных реакций
        return eq.replace('=', ' ➝ ') + " <small style='font-size:0.6em; color:gray;'>(Авто-решение для этой реакции пока недоступно)</small>";
    }

    /* ================= АВТОДОПОЛНЕНИЕ ================= */
    const inp = document.getElementById('in-react');
    const list = document.getElementById('sugg-list');

    inp.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        list.innerHTML = '';
        if(!val) { list.style.display = 'none'; return; }

        const matches = SUGGESTIONS.filter(s => s.toLowerCase().includes(val));
        if(matches.length) {
            list.style.display = 'block';
            matches.forEach(s => {
                let div = document.createElement('div');
                div.className = 'sugg-item';
                div.innerText = s;
                div.onclick = () => {
                    inp.value = s;
                    list.style.display = 'none';
                    calcReact();
                };
                list.appendChild(div);
            });
        } else {
            list.style.display = 'none';
        }
    });

    document.addEventListener('click', (e) => {
        if(e.target !== inp && e.target.parentNode !== list) list.style.display = 'none';
    });
</script>
</body>
</html>
